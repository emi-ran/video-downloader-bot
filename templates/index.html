<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .container { max-width: 500px; margin-top: 60px; }
        .spinner-border { width: 2rem; height: 2rem; }
    </style>
</head>
<body>
<div class="container shadow rounded bg-white p-4">
    <h2 class="mb-4 text-center">Video Downloader</h2>
    <div id="step-link">
        <label for="video-url" class="form-label">Video Linki (YouTube, Instagram, TikTok)</label>
        <input type="text" class="form-control mb-2" id="video-url" placeholder="https://...">
        <button class="btn btn-primary w-100" id="btn-continue">Devam</button>
    </div>
    <div id="step-quality" style="display:none;"></div>
    <div id="step-audio" style="display:none;"></div>
    <div id="step-convert" style="display:none;"></div>
    <div id="step-download" style="display:none;"></div>
    <div id="msg" class="mt-3"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let current = { url: '', platform: '', video_index: null, audio_index: null };
let currentThumb = null;
let streams = [];

function showMsg(msg, type='info') {
    document.getElementById('msg').innerHTML = `<div class="alert alert-${type} py-2">${msg}</div>`;
}
function clearMsg() { document.getElementById('msg').innerHTML = ''; }

// 1. Link girildiğinde platform ve kalite seçeneklerini getir
const btnContinue = document.getElementById('btn-continue');
btnContinue.onclick = async function() {
    clearMsg();
    let url = document.getElementById('video-url').value.trim();
    if (!url) { showMsg('Lütfen bir link girin.', 'warning'); return; }
    current = { url, platform: '', video_index: null, audio_index: null };
    currentThumb = null;
    streams = [];
    document.getElementById('step-link').style.display = 'none';
    showMsg('İşleniyor... <span class="spinner-border spinner-border-sm"></span>');
    let resp = await fetch('/api/process', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url})
    });
    let data = await resp.json();
    if (!data.success) {
        showMsg(data.error || 'Bir hata oluştu.', 'danger');
        document.getElementById('step-link').style.display = '';
        return;
    }
    clearMsg();
    current.platform = data.platform;
    if (data.platform === 'youtube') {
        currentThumb = data.thumbnail_url;
        streams = data.streams;
        let html = '';
        if (currentThumb) {
            html += `<div class='text-center mb-2'><img src='${currentThumb}' alt='Kapak' class='img-fluid rounded' style='max-height:180px;'></div>`;
        }
        html += `<h5>${data.title}</h5><h6 class='mt-3'>Video Kalitesi Seçin</h6>`;
        streams.forEach(s => {
            html += `<button class="btn btn-outline-primary w-100 my-1" onclick="selectQuality(${s.index})">${s.resolution} (${s.fps}fps) - ${s.size_mb}MB</button>`;
        });
        html += `<button class="btn btn-secondary w-100 my-2" onclick="backToLink()">Geri</button>`;
        document.getElementById('step-quality').innerHTML = html;
        document.getElementById('step-quality').style.display = '';
    } else {
        showConvertBtn();
    }
};

window.selectQuality = function(idx) {
    current.video_index = idx;
    let stream = streams.find(s => s.index === idx);
    if (stream && !stream.is_progressive) {
        // Ses seçimi (şimdilik varsayılan)
        let html = `<h5>Ses Kalitesi Seçin</h5>`;
        html += `<button class="btn btn-outline-primary w-100 my-1" onclick="selectAudio(1)">En iyi ses (varsayılan)</button>`;
        html += `<button class="btn btn-secondary w-100 my-2" onclick="backToQuality()">Geri</button>`;
        document.getElementById('step-quality').style.display = 'none';
        document.getElementById('step-audio').innerHTML = html;
        document.getElementById('step-audio').style.display = '';
    } else {
        document.getElementById('step-quality').style.display = 'none';
        showConvertBtn();
    }
};
window.selectAudio = function(idx) {
    current.audio_index = idx;
    document.getElementById('step-audio').style.display = 'none';
    showConvertBtn();
};
function showConvertBtn() {
    let html = `<button class="btn btn-success w-100" id="btn-convert">Dönüştür ve Hazırla</button>`;
    document.getElementById('step-convert').innerHTML = html;
    document.getElementById('step-convert').style.display = '';
    document.getElementById('btn-convert').onclick = doConvert;
}
async function doConvert() {
    clearMsg();
    document.getElementById('step-convert').innerHTML = '<div class="text-center"><span class="spinner-border"></span> Dönüştürülüyor...</div>';
    let resp = await fetch('/api/convert', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(current)
    });
    let data = await resp.json();
    if (!data.success) {
        showMsg(data.error || 'Bir hata oluştu.', 'danger');
        document.getElementById('step-convert').innerHTML = '';
        return;
    }
    document.getElementById('step-convert').innerHTML = '';
    let html = `<div class="alert alert-success">Video hazır! <br> <a href="${data.download_url}" class="btn btn-primary mt-2">İndir</a><br><small>${data.info}</small></div>`;
    html += `<button class="btn btn-outline-secondary w-100 mt-3" onclick="resetAll()">Başka video dönüştür</button>`;
    document.getElementById('step-download').innerHTML = html;
    document.getElementById('step-download').style.display = '';
}
window.resetAll = function() {
    document.getElementById('step-download').style.display = 'none';
    document.getElementById('step-convert').style.display = 'none';
    document.getElementById('step-audio').style.display = 'none';
    document.getElementById('step-quality').style.display = 'none';
    document.getElementById('step-link').style.display = '';
    document.getElementById('video-url').value = '';
    clearMsg();
    current = { url: '', platform: '', video_index: null, audio_index: null };
    currentThumb = null;
    streams = [];
};
window.backToLink = function() {
    document.getElementById('step-quality').style.display = 'none';
    document.getElementById('step-link').style.display = '';
    clearMsg();
};
window.backToQuality = function() {
    document.getElementById('step-audio').style.display = 'none';
    document.getElementById('step-quality').style.display = '';
    clearMsg();
};
</script>
</body>
</html> 